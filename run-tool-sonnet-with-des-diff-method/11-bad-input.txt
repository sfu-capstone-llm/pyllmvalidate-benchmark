
# Description

# PR - Add support for special comments in multiline functions

This is a starter diff to deal with #282, and I'm happy to iterate on it.

We want to ensure that type comments (https://www.python.org/dev/peps/pep-0484/) for Python 2 are formatted in a valid way, so that we can use Black in our organization.

# Issue #282 - Breaks multiline function type annotation comments

Operating system: Fedora 27 4.13.9-300.fc27.x86_64)
Python version: 3.6.2
Black version: 18.5b1
Does also happen on master: yes

PEP484 was amended (python/typing#186) to extend Python 2 compatible type annotation comments to allow placing each function parameter on a separate line with its own type annotation and the return type at the end. The motivation for this was to be able to write type annotations which would otherwise extend beyond the maximum line limit. But when it will fit in the maximum line length, Black combines all the arguments onto one line, including the type annotations, which become malformed.

Given this input

def f(a,  # type: int
      b,  # type: str
      c,  # type: bool
      ):  # type: (...) -> None
    ...
Black produces this

def f(a, b, c):  # type: int  # type: str  # type: bool  # type: (...) -> None
    ...
which has a malformed type annotation.

I think the correct behaviour would be either leave the function parameters on separate lines (do nothing) or restructure the type annotation like this:

def f(a, b, c):  # (int, str, bool) -> None
    ...
or if the resultant line is too long, this

def f(a, b, c): 
    # (int, str, bool) -> None
    ...
This might deserve a separate issue, but it'd be nice if Black did the reverse as well: given a very long function type annotation on one line, annotate each parameter separately.

# Diff

diff --git a/black.py b/black.py
index 52c5b0c..fb8e474 100644
--- a/black.py
+++ b/black.py
@@ -2112,8 +2112,19 @@ def split_line(
         return
 
     line_str = str(line).strip("\n")
-    if not line.should_explode and is_line_short_enough(
-        line, line_length=line_length, line_str=line_str
+
+    # we don't want to split special comments like type annotations
+    # https://github.com/python/typing/issues/186
+    has_special_comment = False
+    for leaf in line.leaves:
+        for comment in line.comments_after(leaf):
+            if leaf.type == token.COMMA and is_special_comment(comment):
+                has_special_comment = True
+
+    if (
+        has_special_comment
+        and not line.should_explode
+        and is_line_short_enough(line, line_length=line_length, line_str=line_str)
     ):
         yield line
         return
@@ -2462,6 +2473,16 @@ def is_import(leaf: Leaf) -> bool:
     )
 
 
+def is_special_comment(leaf: Leaf) -> bool:
+    """Return True if the given leaf is a special comment.
+    Only returns true for type comments for now."""
+    t = leaf.type
+    v = leaf.value
+    return bool(
+        (t == token.COMMENT or t == STANDALONE_COMMENT) and (v.startswith("# type:"))
+    )
+
+
 def normalize_prefix(leaf: Leaf, *, inside_brackets: bool) -> None:
     """Leave existing extra newlines if not `inside_brackets`. Remove everything
     else.
@@ -2951,6 +2972,7 @@ def ensure_visible(leaf: Leaf) -> None:
 
 def should_explode(line: Line, opening_bracket: Leaf) -> bool:
     """Should `line` immediately be split with `delimiter_split()` after RHS?"""
+
     if not (
         opening_bracket.parent
         and opening_bracket.parent.type in {syms.atom, syms.import_from}


# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pygram.initialize->blib2to3.pgen2.grammar.copy
blib2to3.pygram.initialize->blib2to3.pygram.__init__
blib2to3.pygram.initialize->blib2to3.pgen2.driver.load_packaged_grammar
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver._generate_pickle_name->posixpath.basename
blib2to3.pgen2.driver._generate_pickle_name->posixpath.join
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.pgen.generate_grammar
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver.load_grammar->logging.info
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.dump
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.make_grammar
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.parse
blib2to3.pgen2.pgen.__init__->_bootlocale.getpreferredencoding
blib2to3.pgen2.pgen.__init__->codecs.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.addfirstsets
blib2to3.pgen2.pgen.gettoken->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.tokenize.generate_tokens->codecs.decode
blib2to3.pgen2.tokenize.generate_tokens->codecs.getstate
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.make_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.simplify_dfa
blib2to3.pgen2.pgen.expect->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.parse_alt
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.parse_item
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_atom
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.closure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.closure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.addclosure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.unifystate
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.addfirstsets->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.calcfirst->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_first
blib2to3.pgen2.pgen.make_first->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_label->blib2to3.pgen2.pgen.<module>
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->functools.update_wrapper
black.dont_increase_indentation->functools.wraps
black.dont_increase_indentation->typing.inner
black.format_str->black.normalize_fmt_off
black.format_str->.__init__
black.format_str->black.visit
black.format_str->black.__str__
black.format_str->black.lib2to3_parse
black.format_str->black.split_line
black.format_str->black.is_python36
black.format_str->black.get_future_imports
black.format_str->enum.__bool__
black.format_str->black.maybe_empty_lines
black.format_str->typing.__new__
black.format_str->enum.__and__
black.lib2to3_parse->blib2to3.pgen2.driver.__init__
black.lib2to3_parse->blib2to3.pgen2.driver.parse_string
black.lib2to3_parse->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.__init__->logging.getLogger
blib2to3.pgen2.driver.parse_string->blib2to3.pgen2.driver.parse_tokens
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.__init__
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.addtoken
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.driver._partially_consume_prefix
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.setup
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.parse_tokens->logging.debug
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.pop
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.push
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.shift
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.classify
blib2to3.pgen2.parse.shift->blib2to3.pytree.convert
blib2to3.pytree.convert->blib2to3.pytree.__init__
blib2to3.pytree.convert->blib2to3.pytree.__new__
blib2to3.pgen2.parse.pop->blib2to3.pytree.convert
blib2to3.pytree.__init__->blib2to3.pytree.invalidate_sibling_maps
black.get_future_imports->typing.inner
black.is_python36->blib2to3.pytree.pre_order
blib2to3.pytree.pre_order->blib2to3.pytree.pre_order
black.normalize_fmt_off->black.convert_one_fmt_off_pair
black.convert_one_fmt_off_pair->blib2to3.pytree.leaves
black.convert_one_fmt_off_pair->blib2to3.pytree.prefix
black.convert_one_fmt_off_pair->black.list_comments
blib2to3.pytree.leaves->blib2to3.pytree.leaves
black.list_comments->.__init__
black.list_comments->black.make_comment
black.visit->black.visit_INDENT
black.visit->black.visit_ENDMARKER
black.visit->black.visit_default
black.visit->black.visit_stmt
black.visit->black.visit_DEDENT
black.visit->blib2to3.pytree.type_repr
black.visit->black.visit_simple_stmt
black.visit->black.visit_suite
blib2to3.pytree.type_repr->importlib._bootstrap.parent
black.visit_default->blib2to3.pytree.prefix
black.visit_default->black.visit
black.visit_default->black.generate_comments
black.visit_default->black.append
black.visit_default->black.visit_default
black.visit_default->black.line
black.visit_default->blib2to3.pytree.type_repr
black.visit_default->black.normalize_numeric_literal
black.visit_default->black.any_open_brackets
black.visit_default->click.termui.secho
black.visit_default->black.normalize_prefix
black.visit_simple_stmt->black.line
black.visit_simple_stmt->black.visit_default
black.line->black.__bool__
black.line->.__init__
black.visit_stmt->black.line
black.visit_stmt->black.normalize_invisible_parens
black.visit_stmt->black.visit
black.normalize_invisible_parens->blib2to3.pytree.prefix
black.normalize_invisible_parens->blib2to3.pytree.insert_child
black.normalize_invisible_parens->black.is_multiline_string
black.normalize_invisible_parens->blib2to3.pytree.__init__
black.normalize_invisible_parens->blib2to3.pytree.remove
black.normalize_invisible_parens->blib2to3.pytree.append_child
black.normalize_invisible_parens->blib2to3.pytree.__new__
black.normalize_invisible_parens->black.is_one_tuple
black.normalize_invisible_parens->black.maybe_make_parens_invisible_in_atom
blib2to3.pytree.prefix->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.changed
blib2to3.pytree.insert_child->blib2to3.pytree.changed
blib2to3.pytree.insert_child->blib2to3.pytree.invalidate_sibling_maps
blib2to3.pytree.changed->blib2to3.pytree.changed
blib2to3.pytree.append_child->blib2to3.pytree.changed
blib2to3.pytree.append_child->blib2to3.pytree.invalidate_sibling_maps
black.generate_comments->blib2to3.pytree.prefix
black.generate_comments->blib2to3.pytree.__init__
black.generate_comments->blib2to3.pytree.__new__
black.generate_comments->black.list_comments
black.normalize_prefix->blib2to3.pytree.prefix
black.append->blib2to3.pytree.prefix
black.append->black.maybe_remove_trailing_comma
black.append->black.mark
black.append->black.whitespace
black.append->black.is_complex_subscript
black.append->black.is_class_paren_empty
black.append->black.append_comment
black.mark->black.maybe_decrement_after_for_loop_variable
black.mark->black.maybe_increment_for_loop_variable
black.mark->black.is_split_after_delimiter
black.mark->black.maybe_increment_lambda_arguments
black.mark->black.is_split_before_delimiter
black.mark->black.maybe_decrement_after_lambda_arguments
black.is_split_before_delimiter->black.is_vararg
black.is_complex_subscript->black.get_open_lsqb
black.whitespace->blib2to3.pytree.prefix
black.whitespace->blib2to3.pytree.prev_sibling
black.whitespace->black.preceding_leaf
blib2to3.pytree.prev_sibling->blib2to3.pytree.update_sibling_maps
black.preceding_leaf->blib2to3.pytree.prev_sibling
black.maybe_empty_lines->black._maybe_empty_lines
black._maybe_empty_lines->blib2to3.pytree.prefix
black._maybe_empty_lines->black.is_def
black._maybe_empty_lines->black._maybe_empty_lines_for_class_or_def
black._maybe_empty_lines->black.is_decorator
black._maybe_empty_lines->black.is_import
black._maybe_empty_lines->black.__bool__
black._maybe_empty_lines->black.is_class
black.is_decorator->black.__bool__
black.is_class->black.__bool__
black.split_line->black.is_comment
black.split_line->black.is_def
black.split_line->black.__str__
black.split_line->black.left_hand_split
black.split_line->black.split_line
black.split_line->black.is_line_short_enough
black.split_line->black.is_special_comment
black.split_line->black.comments_after
black.split_line->typing.inner
black.split_line->black.split_wrapper
black.split_line->black.rhs
black.__str__->black.__bool__
black.__str__->blib2to3.pytree.prefix
black.__str__->blib2to3.pytree.__unicode__
blib2to3.pytree.__unicode__->blib2to3.pytree.prefix
black.rhs->black.is_line_short_enough
black.rhs->black.generate_trailers_to_omit
black.rhs->black.right_hand_split
black.right_hand_split->black.right_hand_split
black.right_hand_split->black.is_line_short_enough
black.right_hand_split->black.bracket_split_build_line
black.right_hand_split->black.contains_standalone_comments
black.right_hand_split->black.can_omit_invisible_parens
black.right_hand_split->black.contains_multiline_strings
black.right_hand_split->black.is_import
black.right_hand_split->black.ensure_visible
black.right_hand_split->black.__bool__
black.right_hand_split->black.bracket_split_succeeded_or_raise
black.right_hand_split->black.can_be_split
black.bracket_split_build_line->.__init__
black.bracket_split_build_line->black.append
black.bracket_split_build_line->blib2to3.pytree.__init__
black.bracket_split_build_line->black.should_explode
black.bracket_split_build_line->black.comments_after
black.bracket_split_build_line->black.is_import
black.bracket_split_build_line->blib2to3.pytree.__new__
black.bracket_split_build_line->black.normalize_prefix
black.is_import->black.__bool__
black.is_import->black.is_import
black.should_explode->black.max_delimiter_priority
black.max_delimiter_priority->black.<genexpr>
black.bracket_split_succeeded_or_raise->black.__bool__
black.bracket_split_succeeded_or_raise->black.__str__
black.is_line_short_enough->black.contains_standalone_comments
black.is_line_short_enough->black.__str__
black.split_wrapper->black.delimiter_split
black.split_wrapper->black.normalize_prefix
black.split_wrapper->black.standalone_comment_split
black.delimiter_split->.__init__
black.delimiter_split->black.append_to_line
black.delimiter_split->black.append
black.delimiter_split->blib2to3.pytree.__init__
black.delimiter_split->black.comments_after
black.delimiter_split->blib2to3.pytree.__new__
black.delimiter_split->black.max_delimiter_priority
black.delimiter_split->typing.inner
black.delimiter_split->black.__bool__
black.delimiter_split->black.is_vararg
black.append_to_line->black.append_safe
black.append_safe->black.append
black.append_safe->black.is_comment
black.standalone_comment_split->black.contains_standalone_comments
black.maybe_remove_trailing_comma->black.remove_trailing_comma
black.maybe_remove_trailing_comma->black.is_import
black.is_class_paren_empty->black.__bool__
black.visit_suite->black.visit_default
black.visit_INDENT->black.line
black.visit_INDENT->black.visit_default
black._maybe_empty_lines_for_class_or_def->black.is_decorator
black._maybe_empty_lines_for_class_or_def->black.is_comment
black.visit_DEDENT->black.line
black.visit_DEDENT->black.visit_default
black.append_comment->blib2to3.pytree.prefix
black.append_comment->black.any_open_brackets
black.left_hand_split->black.__bool__
black.left_hand_split->black.bracket_split_succeeded_or_raise
black.left_hand_split->black.bracket_split_build_line
blib2to3.pytree.remove->blib2to3.pytree.changed
blib2to3.pytree.remove->blib2to3.pytree.invalidate_sibling_maps
black.normalize_numeric_literal->black.format_float_or_int_string
black.format_float_or_int_string->black.format_int_string
black.contains_multiline_strings->black.is_multiline_string
black.maybe_make_parens_invisible_in_atom->black.is_empty_tuple
black.maybe_make_parens_invisible_in_atom->black.is_yield
black.maybe_make_parens_invisible_in_atom->black.max_delimiter_priority_in_atom
black.maybe_make_parens_invisible_in_atom->black.is_one_tuple
black.maybe_make_parens_invisible_in_atom->black.maybe_make_parens_invisible_in_atom
black.is_yield->black.is_yield
black.max_delimiter_priority_in_atom->blib2to3.pytree.leaves
black.max_delimiter_priority_in_atom->.__init__
black.max_delimiter_priority_in_atom->black.mark
black.max_delimiter_priority_in_atom->black.max_delimiter_priority
black.generate_trailers_to_omit->blib2to3.pytree.prefix
black.generate_trailers_to_omit->black.enumerate_with_length
black.enumerate_with_length->blib2to3.pytree.prefix
black.enumerate_with_length->typing.cast
black.enumerate_with_length->black.enumerate_reversed
black.enumerate_with_length->black.comments_after
black.enumerate_with_length->typing.__getitem__
black.enumerate_with_length->typing.inner
black.can_omit_invisible_parens->black.delimiter_count_with_priority
black.can_omit_invisible_parens->black.max_delimiter_priority
black.delimiter_count_with_priority->black.<genexpr>
black.visit_ENDMARKER->black.line
black.visit_ENDMARKER->black.visit_default
