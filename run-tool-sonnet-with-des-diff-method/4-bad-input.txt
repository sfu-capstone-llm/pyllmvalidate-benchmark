
# Description

# PR - Fix unstable format involving backslash + whitespace at beginning of file 

This PR fixes #922 - an unstable sort involve Python line continuation with \. The issue describes the problem pretty well.

To my knowledge, there should be no situation where Black outputs a file formatted with empty lines at the beginning. By performing this check in the format function, we fix the above issue.

NOTE: Open to feedback on this solution, threw it together pretty quickly after doing some basic debugging of how Black parses lines and whatnot. Open to feedback on it. Also, I'm pretty sure it doesn't break any invariants of the formatter, but would like feedback on that as well.

# Issue #922 - Black produced different code on the second pass of the formatter: Explicit line join in the first line

Operating system: macOS Mojave 10.14.5 (18F132)
Python version: Python 3.7.3
Black version: 19.3b0 (f3bb22a)
Does also happen on master: yes

Minified reproducer:

\


pass
Black diff:

--- source
+++ first pass
@@ -1,5 +1,3 @@
-\
-

 pass

--- first pass
+++ second pass
@@ -1,3 +1,2 @@
-
 pass
Looks like some kind of boundary condition in EmptyLineTracker?

# Diff

diff --git a/black.py b/black.py
index f7022d8..05edf1a 100644
--- a/black.py
+++ b/black.py
@@ -1480,7 +1480,13 @@ class EmptyLineTracker:
         lines (two on module-level).
         """
         before, after = self._maybe_empty_lines(current_line)
-        before -= self.previous_after
+        before = (
+            # Black should not insert empty lines at the beginning
+            # of the file
+            0
+            if self.previous_line is not None
+            else before - self.previous_after
+        )
         self.previous_after = after
         self.previous_line = current_line
         return before, after

# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pygram.initialize->blib2to3.pygram.__init__
blib2to3.pygram.initialize->blib2to3.pgen2.driver.load_packaged_grammar
blib2to3.pygram.initialize->blib2to3.pgen2.grammar.copy
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver._generate_pickle_name->posixpath.join
blib2to3.pgen2.driver._generate_pickle_name->posixpath.basename
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.load
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.driver._newer->genericpath.getmtime
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->typing.inner
black.dont_increase_indentation->functools.wraps
black.dont_increase_indentation->functools.update_wrapper
black.format_str->black.get_future_imports
black.format_str->black.supports_feature
black.format_str->.__init__
black.format_str->black.split_line
black.format_str->typing.__new__
black.format_str->enum.__hash__
black.format_str->black.<setcomp>
black.format_str->black.visit
black.format_str->black.maybe_empty_lines
black.format_str->black.__str__
black.format_str->black.detect_target_versions
black.format_str->black.normalize_fmt_off
black.format_str->black.lib2to3_parse
black.lib2to3_parse->blib2to3.pgen2.driver.__init__
black.lib2to3_parse->blib2to3.pgen2.tokenize.generate_tokens
black.lib2to3_parse->blib2to3.pgen2.driver.parse_string
black.lib2to3_parse->black.get_grammars
blib2to3.pgen2.driver.__init__->logging.getLogger
blib2to3.pgen2.driver.parse_string->blib2to3.pgen2.driver.parse_tokens
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.__init__
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.addtoken
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.parse_tokens->logging.debug
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.setup
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.classify
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.push
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.pop
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.shift
blib2to3.pgen2.parse.shift->blib2to3.pytree.convert
blib2to3.pytree.convert->blib2to3.pytree.__init__
blib2to3.pytree.convert->blib2to3.pytree.__new__
blib2to3.pgen2.parse.pop->blib2to3.pytree.convert
blib2to3.pytree.__init__->blib2to3.pytree.invalidate_sibling_maps
black.get_future_imports->typing.inner
black.detect_target_versions->enum.__iter__
black.detect_target_versions->black.<setcomp>
black.detect_target_versions->black.get_features_used
black.get_features_used->blib2to3.pytree.pre_order
blib2to3.pytree.pre_order->blib2to3.pytree.pre_order
black.normalize_fmt_off->black.convert_one_fmt_off_pair
black.convert_one_fmt_off_pair->black.list_comments
black.convert_one_fmt_off_pair->blib2to3.pytree.prefix
black.convert_one_fmt_off_pair->blib2to3.pytree.leaves
blib2to3.pytree.leaves->blib2to3.pytree.leaves
black.supports_feature->black.<genexpr>
black.visit->blib2to3.pytree.type_repr
black.visit->black.visit_simple_stmt
black.visit->black.visit_ENDMARKER
black.visit->black.visit_default
blib2to3.pytree.type_repr->importlib._bootstrap.parent
black.visit_default->black.normalize_string_quotes
black.visit_default->black.any_open_brackets
black.visit_default->black.generate_comments
black.visit_default->black.visit
black.visit_default->click.termui.secho
black.visit_default->black.visit_default
black.visit_default->blib2to3.pytree.prefix
black.visit_default->black.normalize_prefix
black.visit_default->black.append
black.visit_default->blib2to3.pytree.type_repr
black.visit_default->black.normalize_string_prefix
black.generate_comments->blib2to3.pytree.prefix
black.generate_comments->black.list_comments
black.normalize_prefix->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.changed
blib2to3.pytree.changed->blib2to3.pytree.changed
black.visit_simple_stmt->black.line
black.visit_simple_stmt->black.visit_default
black.line->.__init__
black.line->black.__bool__
black.append->black.whitespace
black.append->black.maybe_remove_trailing_comma
black.append->black.mark
black.append->black.append_comment
black.append->blib2to3.pytree.prefix
black.append->black.is_complex_subscript
black.mark->black.is_split_before_delimiter
black.mark->black.maybe_decrement_after_lambda_arguments
black.mark->black.maybe_increment_for_loop_variable
black.mark->black.maybe_increment_lambda_arguments
black.mark->black.is_split_after_delimiter
black.mark->black.maybe_decrement_after_for_loop_variable
black.is_split_before_delimiter->black.is_vararg
black.is_complex_subscript->black.get_open_lsqb
black.whitespace->blib2to3.pytree.prev_sibling
black.whitespace->black.preceding_leaf
blib2to3.pytree.prev_sibling->blib2to3.pytree.update_sibling_maps
black.preceding_leaf->blib2to3.pytree.prev_sibling
black.normalize_string_prefix->re.match
black.normalize_string_quotes->black.sub_twice
black.normalize_string_quotes->re.compile
black.sub_twice->re._subx
black.visit_ENDMARKER->black.line
black.visit_ENDMARKER->black.visit_default
black.maybe_empty_lines->black._maybe_empty_lines
black._maybe_empty_lines->black.is_decorator
black._maybe_empty_lines->black.is_class
black._maybe_empty_lines->blib2to3.pytree.prefix
black._maybe_empty_lines->black.is_def
black.is_decorator->black.__bool__
black.is_class->black.__bool__
black.__str__->blib2to3.pytree.__unicode__
black.__str__->black.__bool__
black.__str__->blib2to3.pytree.prefix
black.split_line->black.is_line_short_enough
black.split_line->black.is_comment
black.split_line->black.__str__
black.split_line->black.contains_inner_type_comments
blib2to3.pytree.__unicode__->blib2to3.pytree.prefix
black.is_line_short_enough->black.contains_standalone_comments
