
# Description

# PR - [#154] Handle comments between decorators properly

# Issue #154 - Adds blank lines after comment between decorators

Given t.py:

@property
# TODO: X
@property
def foo():
    pass
Running black --diff t.py gives:

--- t-black.py  (original)
+++ t-black.py  (formatted)
@@ -1,6 +1,8 @@
 @property
 # TODO: X
+
+
 @property
 def foo():
     pass
Where flake8 then complains:

stdin:5:1: E304 blank lines found after function decorator

Operating system: Arch Linux
Python version: 3.6.5
Black version: 18.4a2
Does also happen on master: Haven't checked.



# Diff

diff --git a/black.py b/black.py
index 15a7547..a03b9aa 100644
--- a/black.py
+++ b/black.py
@@ -1044,6 +1044,10 @@ class EmptyLineTracker:
                 # Don't insert empty lines between decorators.
                 return 0, 0
 
+            if is_decorator and self.previous_line and self.previous_line.is_comment:
+                # Don't insert empty lines between decorator comments.
+                return 0, 0
+
             newlines = 2
             if current_line.depth:
                 newlines -= 1


# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver.load_grammar->logging.info
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.pgen.generate_grammar
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.dump
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.make_grammar
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.addfirstsets
blib2to3.pgen2.pgen.__init__->_bootlocale.getpreferredencoding
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.__init__->codecs.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.parse
blib2to3.pgen2.pgen.gettoken->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.tokenize.generate_tokens->codecs.getstate
blib2to3.pgen2.tokenize.generate_tokens->codecs.decode
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.simplify_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.make_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.expect->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.parse_alt
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.parse_item
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_atom
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.closure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.closure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.addclosure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.unifystate
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.addfirstsets->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.calcfirst->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_first
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_first->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_label->blib2to3.pgen2.pgen.<module>
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->typing.inner
black.dont_increase_indentation->functools.update_wrapper
black.dont_increase_indentation->functools.wraps
black.format_str->black.lib2to3_parse
black.format_str->typing.__new__
black.format_str->black.is_python36
black.format_str->black.visit
black.format_str->black.maybe_empty_lines
black.format_str->black.__str__
black.format_str->.__init__
black.format_str->black.split_line
black.lib2to3_parse->blib2to3.pgen2.driver.parse_string
black.lib2to3_parse->blib2to3.pgen2.driver.__init__
black.lib2to3_parse->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.__init__->logging.getLogger
blib2to3.pgen2.driver.parse_string->blib2to3.pgen2.driver.parse_tokens
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.addtoken
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.__init__
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.driver._partially_consume_prefix
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.setup
blib2to3.pgen2.driver.parse_tokens->logging.debug
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.pop
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.push
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.classify
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.shift
blib2to3.pgen2.parse.shift->blib2to3.pytree.convert
blib2to3.pytree.convert->blib2to3.pytree.__init__
blib2to3.pytree.convert->blib2to3.pytree.__new__
blib2to3.pgen2.parse.pop->blib2to3.pytree.convert
black.is_python36->blib2to3.pytree.pre_order
blib2to3.pytree.pre_order->blib2to3.pytree.pre_order
black.visit->black.visit_simple_stmt
black.visit->blib2to3.pytree.type_repr
black.visit->black.visit_default
black.visit->black.visit_decorators
black.visit->black.visit_ENDMARKER
black.visit->black.visit_DEDENT
black.visit->black.visit
black.visit->black.visit_stmt
black.visit->black.visit_INDENT
blib2to3.pytree.type_repr->importlib._bootstrap.parent
black.visit_default->black.line
black.visit_default->black.append
black.visit_default->black.generate_comments
black.visit_default->black.visit_default
black.visit_default->black.any_open_brackets
black.visit_default->black.visit
black.visit_default->black.normalize_prefix
black.visit_decorators->black.visit
black.visit_decorators->black.line
black.line->.__init__
black.line->black.__bool__
black.generate_comments->blib2to3.pytree.prefix
black.generate_comments->blib2to3.pytree.__init__
black.generate_comments->black.make_comment
black.generate_comments->blib2to3.pytree.__new__
black.normalize_prefix->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.changed
blib2to3.pytree.changed->blib2to3.pytree.changed
black.append->black.whitespace
black.append->black.append_comment
black.append->black.mark
black.append->black.maybe_remove_trailing_comma
black.append->blib2to3.pytree.prefix
black.mark->black.is_split_before_delimiter
black.mark->black.maybe_decrement_after_lambda_arguments
black.mark->black.maybe_increment_for_loop_variable
black.mark->black.is_split_after_delimiter
black.mark->black.maybe_increment_lambda_arguments
black.mark->black.maybe_decrement_after_for_loop_variable
black.is_split_before_delimiter->black.is_vararg
black.whitespace->black.preceding_leaf
black.whitespace->blib2to3.pytree.prev_sibling
black.maybe_empty_lines->black._maybe_empty_lines
black._maybe_empty_lines->black.is_comment
black._maybe_empty_lines->black.__bool__
black._maybe_empty_lines->black.is_decorator
black._maybe_empty_lines->black.is_import
black._maybe_empty_lines->black.is_def
black._maybe_empty_lines->black.is_yield
black._maybe_empty_lines->black.is_class
black._maybe_empty_lines->blib2to3.pytree.prefix
black._maybe_empty_lines->black.is_flow_control
black.is_decorator->black.__bool__
black.split_line->black.__str__
black.split_line->black.is_comment
black.split_line->black.contains_standalone_comments
black.__str__->blib2to3.pytree.prefix
black.__str__->black.__bool__
black.__str__->blib2to3.pytree.__unicode__
blib2to3.pytree.__unicode__->blib2to3.pytree.prefix
black.append_comment->blib2to3.pytree.prefix
black.append_comment->black.any_open_brackets
black.is_class->black.__bool__
black.is_flow_control->black.__bool__
black.is_import->black.is_import
black.is_import->black.__bool__
black.is_yield->black.__bool__
black.visit_stmt->black.visit
black.visit_stmt->black.line
black.visit_stmt->black.normalize_invisible_parens
black.preceding_leaf->blib2to3.pytree.prev_sibling
black.visit_INDENT->black.line
black.visit_INDENT->black.visit_default
black.visit_simple_stmt->black.line
black.visit_simple_stmt->black.visit_default
black.visit_DEDENT->black.line
black.visit_DEDENT->black.visit_default
black.visit_ENDMARKER->black.visit_default
black.visit_ENDMARKER->black.line
black.assert_equivalent->typing.inner
black.assert_equivalent->ast.parse
black.assert_equivalent->black._v
black._v->black._v
black.assert_stable->black.format_str

# Coverage

Name                  Stmts   Miss  Cover   Missing
---------------------------------------------------
black.py               1343    770    43%   87-88, 91, 95-96, 175-215, 226-251, 270-315, 331-354, 365-380, 392-402, 419, 422, 439-440, 447-456, 459, 465-466, 503-520, 528-529, 631, 635, 653, 662-664, 671-673, 684-686, 693-695, 741-750, 781-782, 823-824, 837-875, 883-884, 896-897, 901-910, 914-919, 924, 933, 952-962, 969-975, 979, 983, 987, 1011, 1030, 1033-1034, 1051-1054, 1057, 1065, 1072, 1098, 1112, 1125, 1138-1147, 1152, 1203-1205, 1213-1224, 1238-1256, 1260, 1269-1283, 1324, 1334, 1337, 1340-1350, 1353-1354, 1357-1358, 1365, 1376, 1379, 1388-1389, 1393-1406, 1410-1413, 1417-1430, 1434-1443, 1450-1455, 1458-1462, 1466-1474, 1477-1479, 1483-1484, 1488-1505, 1508-1517, 1520, 1533-1540, 1552, 1568, 1575, 1578, 1585, 1593, 1601, 1604, 1653, 1656-1661, 1676, 1681, 1712-1739, 1748-1780, 1787-1844, 1861-1867, 1881-1883, 1895-1948, 1954-1977, 2020-2070, 2082-2105, 2112, 2122-2136, 2154-2163, 2172-2191, 2200-2203, 2215-2217, 2224-2226, 2241-2249, 2263-2275, 2279-2280, 2293-2299, 2306-2328, 2344-2345, 2364-2366, 2374-2376, 2385-2386, 2398-2402, 2412-2421, 2426-2430, 2437-2439, 2444-2461, 2470, 2482-2491, 2496-2497, 2508-2515, 2520-2527, 2531
tests/__init__.py         0      0   100%
tests/test_black.py     509    394    23%   29, 44-45, 56-62, 67-77, 86-99, 104-109, 113-118, 121-135, 138-152, 156-161, 165-169, 173-177, 180-191, 194-215, 219-223, 227-231, 235-239, 243-247, 251-255, 259-263, 267-271, 275-279, 283-287, 291-295, 299-303, 307-311, 315-319, 322-400, 407-422, 425-442, 449-465, 468-471, 475-491, 494-504, 507-515, 519-537, 540-546, 549-552, 555-556, 559-565, 568-581, 584-587, 591-604, 607-609, 612-627, 639
---------------------------------------------------
TOTAL                  1852   1164    37%

