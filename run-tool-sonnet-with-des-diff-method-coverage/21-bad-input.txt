
# Description

# PR - Open temporary files with utf-8 encoding

This is not the default on Windows. Fixes #124

# Issue #124 - Tests fail on windows

I suspected this had more to do with my git client setup than an actual bug, but since I'm just using the stock GitHub Windows GUI and these files open just fine in notepad, I thought I'd file an issue here.

The problem is caused by these characters: https://github.com/ambv/black/blob/master/tests/expression.py#L138-L139

ERROR: test_expression_diff (tests.test_black.BlackTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "c:\users\zsolz\documents\github\black\tests\test_black.py", line 165, in test_expression_diff
    tmp_file = Path(black.dump_to_file(source))
  File "c:\users\zsolz\documents\github\black\black.py", line 2161, in dump_to_file
    f.write(lines)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\tempfile.py", line 483, in func_wrapper
    return func(*args, **kwargs)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\u0142' in position 4011: character maps to <undefined>
ERROR: test_expression_ff (tests.test_black.BlackTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "c:\users\zsolz\documents\github\black\tests\test_black.py", line 150, in test_expression_ff
    tmp_file = Path(black.dump_to_file(source))
  File "c:\users\zsolz\documents\github\black\black.py", line 2161, in dump_to_file
    f.write(lines)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\tempfile.py", line 483, in func_wrapper
    return func(*args, **kwargs)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\u0142' in position 4011: character maps to <undefined>

# Diff

diff --git a/black.py b/black.py
index 537ba59..f6a6c7a 100644
--- a/black.py
+++ b/black.py
@@ -2325,7 +2325,7 @@ def dump_to_file(*output: str) -> str:
     import tempfile
 
     with tempfile.NamedTemporaryFile(
-        mode="w", prefix="blk_", suffix=".log", delete=False
+        mode="w", prefix="blk_", suffix=".log", delete=False, encoding="latin1"
     ) as f:
         for lines in output:
             f.write(lines)


# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->logging.info
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.pgen.generate_grammar
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.dump
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.make_grammar
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.addfirstsets
blib2to3.pgen2.pgen.__init__->_bootlocale.getpreferredencoding
blib2to3.pgen2.pgen.__init__->codecs.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.parse
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.gettoken->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.tokenize.generate_tokens->codecs.decode
blib2to3.pgen2.tokenize.generate_tokens->codecs.getstate
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.make_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.simplify_dfa
blib2to3.pgen2.pgen.expect->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.parse_alt
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.parse_item
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_atom
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.closure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.closure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.addclosure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.unifystate
blib2to3.pgen2.pgen.addfirstsets->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.calcfirst->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_first
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_first->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_label->blib2to3.pgen2.pgen.<module>
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->typing.inner
black.dont_increase_indentation->functools.wraps
black.dont_increase_indentation->functools.update_wrapper
black.dump_to_file->tempfile.NamedTemporaryFile
black.dump_to_file->tempfile.__getattr__
black.dump_to_file->tempfile.func_wrapper
black.dump_to_file->tempfile.__exit__
black.dump_to_file->tempfile.__enter__

# Coverage

Name                  Stmts   Miss  Cover   Missing
---------------------------------------------------
black.py               1258   1035    18%   80-81, 84, 88-89, 162-215, 234-269, 284-307, 318-333, 345-355, 363-378, 391-414, 419-420, 439-443, 447-449, 457-474, 482-483, 557-576, 580, 588, 613-628, 636-645, 650, 655, 660, 665, 674-683, 699, 708, 716-721, 725-770, 778-784, 788-793, 797-815, 819-828, 832-837, 841-852, 856, 870-880, 887-893, 897, 901, 905, 928-935, 938-988, 1008-1017, 1024-1029, 1033-1069, 1074-1075, 1080, 1097-1102, 1106-1114, 1118-1129, 1133-1135, 1143-1161, 1165, 1169-1170, 1174-1188, 1192-1206, 1219-1455, 1460-1473, 1484-1487, 1498-1543, 1551, 1576-1611, 1622-1630, 1646-1687, 1696-1728, 1735-1792, 1809-1815, 1829-1831, 1843-1897, 1903-1926, 1931-1934, 1949-1958, 1969-2015, 2024-2052, 2057, 2067-2081, 2089-2108, 2117-2120, 2130-2145, 2158-2166, 2180-2188, 2192-2193, 2206-2212, 2219-2241, 2247-2299, 2309-2315, 2332-2334, 2339-2343, 2350-2352, 2357-2374, 2378
tests/__init__.py         0      0   100%
tests/test_black.py     354    270    24%   24, 45, 53-69, 73-78, 82-87, 90-104, 107-121, 125-130, 134-138, 142-146, 151-160, 163-184, 188-192, 196-200, 204-208, 212-216, 220-224, 228-232, 236-240, 244-248, 252-256, 260-264, 268-272, 276-280, 283-352, 359-374, 377-394, 401-417, 420-423, 427-443, 447
---------------------------------------------------
TOTAL                  1612   1305    19%

