
# Description

# PR - Open temporary files with utf-8 encoding

This is not the default on Windows. Fixes #124

# Issue #124 - Tests fail on windows

I suspected this had more to do with my git client setup than an actual bug, but since I'm just using the stock GitHub Windows GUI and these files open just fine in notepad, I thought I'd file an issue here.

The problem is caused by these characters: https://github.com/ambv/black/blob/master/tests/expression.py#L138-L139

ERROR: test_expression_diff (tests.test_black.BlackTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "c:\users\zsolz\documents\github\black\tests\test_black.py", line 165, in test_expression_diff
    tmp_file = Path(black.dump_to_file(source))
  File "c:\users\zsolz\documents\github\black\black.py", line 2161, in dump_to_file
    f.write(lines)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\tempfile.py", line 483, in func_wrapper
    return func(*args, **kwargs)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\u0142' in position 4011: character maps to <undefined>
ERROR: test_expression_ff (tests.test_black.BlackTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "c:\users\zsolz\documents\github\black\tests\test_black.py", line 150, in test_expression_ff
    tmp_file = Path(black.dump_to_file(source))
  File "c:\users\zsolz\documents\github\black\black.py", line 2161, in dump_to_file
    f.write(lines)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\tempfile.py", line 483, in func_wrapper
    return func(*args, **kwargs)
  File "C:\Users\zsolz\.virtualenvs\black-TlIYXM7K\lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\u0142' in position 4011: character maps to <undefined>

# Diff

diff --git a/black.py b/black.py
index 537ba59..587d9b3 100644
--- a/black.py
+++ b/black.py
@@ -2325,7 +2325,7 @@ def dump_to_file(*output: str) -> str:
     import tempfile
 
     with tempfile.NamedTemporaryFile(
-        mode="w", prefix="blk_", suffix=".log", delete=False
+        mode="w", prefix="blk_", suffix=".log", delete=False, encoding="utf8"
     ) as f:
         for lines in output:
             f.write(lines)


# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.pgen.generate_grammar
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.dump
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver.load_grammar->logging.info
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.make_grammar
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.addfirstsets
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.parse
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.__init__->_bootlocale.getpreferredencoding
blib2to3.pgen2.pgen.__init__->codecs.__init__
blib2to3.pgen2.pgen.gettoken->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.tokenize.generate_tokens->codecs.decode
blib2to3.pgen2.tokenize.generate_tokens->codecs.getstate
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.make_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.simplify_dfa
blib2to3.pgen2.pgen.expect->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.parse_alt
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.parse_item
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_atom
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.closure
blib2to3.pgen2.pgen.closure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.addclosure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.unifystate
blib2to3.pgen2.pgen.addfirstsets->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.calcfirst->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_first
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.pgen.make_first->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_label->blib2to3.pgen2.pgen.<module>
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->functools.update_wrapper
black.dont_increase_indentation->typing.inner
black.dont_increase_indentation->functools.wraps
black.dump_to_file->tempfile.__getattr__
black.dump_to_file->tempfile.func_wrapper
black.dump_to_file->tempfile.__enter__
black.dump_to_file->tempfile.NamedTemporaryFile
black.dump_to_file->tempfile.__exit__
black.format_file_in_place->codecs.decode
black.format_file_in_place->pathlib.__fspath__
black.format_file_in_place->tokenize.open
black.format_file_in_place->black.format_file_contents
black.format_file_in_place->codecs.__init__
black.format_file_contents->black.format_str
black.format_str->black.lib2to3_parse
black.format_str->black.split_line
black.format_str->.__init__
black.format_str->black.maybe_empty_lines
black.format_str->black.is_python36
black.format_str->black.__str__
black.format_str->typing.__new__
black.format_str->black.visit
black.lib2to3_parse->blib2to3.pgen2.driver.parse_string
black.lib2to3_parse->blib2to3.pgen2.driver.__init__
black.lib2to3_parse->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.__init__->logging.getLogger
blib2to3.pgen2.driver.parse_string->blib2to3.pgen2.driver.parse_tokens
blib2to3.pgen2.driver.parse_tokens->logging.debug
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.__init__
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.addtoken
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.setup
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.classify
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.pop
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.push
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.shift
blib2to3.pgen2.parse.shift->blib2to3.pytree.convert
blib2to3.pytree.convert->blib2to3.pytree.__init__
blib2to3.pytree.convert->blib2to3.pytree.__new__
blib2to3.pgen2.parse.pop->blib2to3.pytree.convert
black.is_python36->blib2to3.pytree.pre_order
blib2to3.pytree.pre_order->blib2to3.pytree.pre_order
black.visit->black.visit_INDENT
black.visit->black.visit_DEDENT
black.visit->black.visit_simple_stmt
black.visit->black.visit_default
black.visit->blib2to3.pytree.type_repr
black.visit->black.visit_async_stmt
black.visit->black.visit_stmt
black.visit->black.visit_ENDMARKER
black.visit->black.visit
blib2to3.pytree.type_repr->importlib._bootstrap.parent
black.visit_default->black.line
black.visit_default->black.visit_default
black.visit_default->black.generate_comments
black.visit_default->black.normalize_string_quotes
black.visit_default->black.normalize_prefix
black.visit_default->black.any_open_brackets
black.visit_default->black.append
black.visit_default->black.visit
black.visit_simple_stmt->black.line
black.visit_simple_stmt->black.visit_default
black.line->black.__bool__
black.line->.__init__
black.generate_comments->blib2to3.pytree.prefix
black.generate_comments->blib2to3.pytree.__init__
black.generate_comments->blib2to3.pytree.__new__
black.generate_comments->black.make_comment
black.normalize_prefix->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.changed
blib2to3.pytree.changed->blib2to3.pytree.changed
black.append->black.whitespace
black.append->black.mark
black.append->black.append_comment
black.append->black.maybe_decrement_after_for_loop_variable
black.append->blib2to3.pytree.prefix
black.append->black.maybe_remove_trailing_comma
black.append->black.maybe_increment_for_loop_variable
black.mark->black.is_split_before_delimiter
black.mark->black.is_split_after_delimiter
black.whitespace->black.preceding_leaf
black.whitespace->blib2to3.pytree.prev_sibling
black.maybe_empty_lines->black._maybe_empty_lines
black._maybe_empty_lines->black.is_flow_control
black._maybe_empty_lines->black.is_decorator
black._maybe_empty_lines->blib2to3.pytree.prefix
black._maybe_empty_lines->black.is_def
black._maybe_empty_lines->black.is_import
black._maybe_empty_lines->black.is_yield
black._maybe_empty_lines->black.is_class
black._maybe_empty_lines->black.__bool__
black.is_decorator->black.__bool__
black.is_class->black.__bool__
black.is_flow_control->black.__bool__
black.split_line->black.right_hand_split
black.split_line->black.is_def
black.split_line->black.split_line
black.split_line->black.contains_standalone_comments
black.split_line->black.split_wrapper
black.split_line->black.__str__
black.split_line->black.is_comment
black.__str__->blib2to3.pytree.prefix
black.__str__->blib2to3.pytree.__unicode__
black.__str__->black.__bool__
blib2to3.pytree.__unicode__->blib2to3.pytree.prefix
black.normalize_string_quotes->re.compile
black.normalize_string_quotes->re._subx
black.is_import->black.is_import
black.is_import->black.__bool__
black.is_yield->black.__bool__
black.preceding_leaf->blib2to3.pytree.leaves
black.preceding_leaf->blib2to3.pytree.prev_sibling
blib2to3.pytree.leaves->blib2to3.pytree.leaves
black.maybe_remove_trailing_comma->black.remove_trailing_comma
black.right_hand_split->black.ensure_visible
black.right_hand_split->black.comments_after
black.right_hand_split->black.bracket_split_succeeded_or_raise
black.right_hand_split->black.normalize_prefix
black.right_hand_split->.__init__
black.right_hand_split->black.append
black.right_hand_split->black.__bool__
black.bracket_split_succeeded_or_raise->black.__str__
black.bracket_split_succeeded_or_raise->black.__bool__
black.split_wrapper->black.delimiter_split
black.split_wrapper->black.standalone_comment_split
black.split_wrapper->black.normalize_prefix
black.delimiter_split->black.append_to_line
black.delimiter_split->black.comments_after
black.delimiter_split->.__init__
black.delimiter_split->typing.inner
black.delimiter_split->black.max_delimiter_priority
black.delimiter_split->black.__bool__
black.max_delimiter_priority->black.<genexpr>
black.append_to_line->black.append_safe
black.append_safe->black.is_comment
black.append_safe->black.append
black.standalone_comment_split->black.contains_standalone_comments
black.visit_stmt->black.line
black.visit_stmt->black.normalize_invisible_parens
black.visit_stmt->black.visit
black.visit_INDENT->black.line
black.visit_INDENT->black.visit_default
black.visit_DEDENT->black.line
black.visit_async_stmt->black.line
black.visit_async_stmt->black.visit
black.normalize_invisible_parens->blib2to3.pytree.__init__
black.normalize_invisible_parens->blib2to3.pytree.__new__
black.normalize_invisible_parens->black.max_delimiter_priority_in_atom
black.normalize_invisible_parens->black.is_empty_tuple
black.normalize_invisible_parens->blib2to3.pytree.remove
black.normalize_invisible_parens->black.is_one_tuple
black.normalize_invisible_parens->blib2to3.pytree.insert_child
blib2to3.pytree.remove->blib2to3.pytree.changed
blib2to3.pytree.insert_child->blib2to3.pytree.changed
black.max_delimiter_priority_in_atom->black.mark
black.max_delimiter_priority_in_atom->blib2to3.pytree.leaves
black.max_delimiter_priority_in_atom->black.max_delimiter_priority
black.max_delimiter_priority_in_atom->.__init__
black.visit_ENDMARKER->black.line
black.visit_ENDMARKER->black.visit_default
black.append_comment->black.any_open_brackets
black.assert_equivalent->ast.parse
black.assert_equivalent->typing.inner
black.assert_equivalent->black._v
black._v->black._v
black.assert_stable->black.format_str

# Coverage

Name                  Stmts   Miss  Cover   Missing
---------------------------------------------------
black.py               1258    414    67%   80-81, 84, 88-89, 162-215, 234-269, 290-291, 296-306, 318-333, 346, 350, 353-354, 393-394, 401-410, 413, 419-420, 457-474, 482-483, 638, 641, 676-677, 718-719, 733-734, 753, 757, 801-802, 809-811, 824, 834-836, 870-880, 887-893, 897, 901, 905, 929, 948, 959, 963, 967, 979, 1012, 1026, 1039, 1052-1061, 1133-1135, 1143-1161, 1165, 1174-1188, 1255, 1291, 1299, 1307, 1314-1327, 1331-1334, 1361, 1368, 1371-1376, 1379-1383, 1392, 1409, 1414, 1424, 1432, 1435, 1441-1450, 1469-1470, 1473, 1522, 1538, 1551, 1601, 1604-1609, 1624, 1629, 1661, 1674, 1696-1728, 1784-1786, 1811-1815, 1845-1846, 1865-1869, 1875, 1896, 1906-1926, 1971, 1974-1975, 1984, 1991-1997, 2006, 2010, 2069, 2090, 2095, 2100, 2134, 2141-2143, 2158-2166, 2180-2188, 2192-2193, 2206-2212, 2219-2241, 2257-2258, 2277-2279, 2287-2289, 2298-2299, 2311-2315, 2333, 2339-2343, 2350-2352, 2357-2374, 2378
tests/__init__.py         0      0   100%
tests/test_black.py     354    259    27%   24, 45, 55-68, 73-78, 82-87, 90-104, 107-121, 125-130, 134-138, 142-146, 163-184, 188-192, 196-200, 204-208, 212-216, 220-224, 228-232, 236-240, 244-248, 252-256, 260-264, 268-272, 276-280, 283-352, 359-374, 377-394, 401-417, 420-423, 427-443, 447
---------------------------------------------------
TOTAL                  1612    673    58%

