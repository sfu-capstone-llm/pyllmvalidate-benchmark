
# Description

# PR - fix handling of comments in from imports

Fixes #671

# Issue 671 - Black produces invalid code with commented out multi-line includes

Howdy! Sorry you're having trouble. To expedite your experience,
provide some basics for me:

Operating system: MacOS
Python version: Python 3.7.1
Black version: 18.9b0
Does also happen on master: Yes

repro:

(black-repro) [schrockn@mbp ~/code/playground/black_bug_repro]$ black test.py
error: cannot format test.py: INTERNAL ERROR: Black produced invalid code: invalid syntax (<unknown>, line 11). Please report a bug on https://github.com/ambv/black/issues.  This invalid output might be helpful: /var/folders/nb/18_t4vkx595_cnpf8nz5gt_80000gn/T/blk_di3puv3v.log
All done! ðŸ’¥ ðŸ’” ðŸ’¥
1 file failed to reformat.
test file:

from .config import (
    Any,
    Bool,
    ConfigType,
    ConfigTypeAttributes,
    Int,
    Path,
    #  String,
    #  resolve_to_config_type,
    #  DEFAULT_TYPE_ATTRIBUTES,
)
The invalid output:

(black-repro) [schrockn@mbp ~/code/playground/black_bug_repro]$ more /var/folders/nb/18_t4vkx595_cnpf8nz5gt_80000gn/T/blk_di3puv3v.log
  File "/Users/schrockn/code/githubs/black/black.py", line 3318, in assert_equivalent
    dst_ast = ast.parse(dst)
  File "/Users/schrockn/.pyenv/versions/3.7.1/lib/python3.7/ast.py", line 35, in parse
    return compile(source, filename, mode, PyCF_ONLY_AST)
from .config import (
    Any,
    Bool,
    ConfigType,
    ConfigTypeAttributes,
    Int,
    Path,
    #  String,
    #  resolve_to_config_type,
    #  DEFAULT_TYPE_ATTRIBUTES,
    ,
)
Thanks!

# Diff

diff --git a/black.py b/black.py
index dd6e372..9ecfbe1 100644
--- a/black.py
+++ b/black.py
@@ -2405,10 +2405,17 @@ def bracket_split_build_line(
         if leaves:
             # Since body is a new indent level, remove spurious leading whitespace.
             normalize_prefix(leaves[0], inside_brackets=True)
-            # Ensure a trailing comma when expected.
+            # Ensure a trailing comma for imports, but be careful not to add one after
+            # any comments.
             if original.is_import:
-                if leaves[-1].type != token.COMMA:
-                    leaves.append(Leaf(token.COMMA, ","))
+                for i in range(len(leaves) - 1, -1, -1):
+                    if leaves[i].type == token.COMMA:
+                        break
+                    elif leaves[i].type == STANDALONE_COMMENT:
+                        continue
+                    else:
+                        leaves.insert(i + 1, Leaf(token.COMMA, ","))
+                        break
     # Populate the line
     for leaf in leaves:
         result.append(leaf, preformatted=True)


# Method Trace

blib2to3.pgen2.tokenize.any->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize.maybe->blib2to3.pgen2.tokenize.group
blib2to3.pgen2.tokenize._combinations->blib2to3.pgen2.tokenize.<genexpr>
blib2to3.pygram.initialize->blib2to3.pgen2.driver.load_packaged_grammar
blib2to3.pygram.initialize->blib2to3.pygram.__init__
blib2to3.pygram.initialize->blib2to3.pgen2.grammar.copy
blib2to3.pgen2.driver.load_packaged_grammar->genericpath.isfile
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver.load_grammar
blib2to3.pgen2.driver.load_packaged_grammar->blib2to3.pgen2.driver._generate_pickle_name
blib2to3.pgen2.driver._generate_pickle_name->posixpath.join
blib2to3.pgen2.driver._generate_pickle_name->posixpath.basename
blib2to3.pgen2.driver._generate_pickle_name->posixpath.splitext
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.load_grammar->tempfile.__del__
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.driver._newer
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.grammar.dump
blib2to3.pgen2.driver.load_grammar->logging.info
blib2to3.pgen2.driver.load_grammar->logging.getLogger
blib2to3.pgen2.driver.load_grammar->blib2to3.pgen2.pgen.generate_grammar
blib2to3.pgen2.driver._newer->genericpath.getmtime
blib2to3.pgen2.driver._newer->genericpath.exists
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.generate_grammar->blib2to3.pgen2.pgen.make_grammar
blib2to3.pgen2.pgen.__init__->codecs.__init__
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.addfirstsets
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.parse
blib2to3.pgen2.pgen.__init__->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.__init__->_bootlocale.getpreferredencoding
blib2to3.pgen2.pgen.gettoken->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.tokenize.generate_tokens->codecs.getstate
blib2to3.pgen2.tokenize.generate_tokens->codecs.decode
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.simplify_dfa
blib2to3.pgen2.pgen.parse->blib2to3.pgen2.pgen.make_dfa
blib2to3.pgen2.pgen.expect->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.parse_alt
blib2to3.pgen2.pgen.parse_rhs->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.parse_item
blib2to3.pgen2.pgen.parse_alt->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.parse_atom
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_item->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.parse_rhs
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.expect
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.gettoken
blib2to3.pgen2.pgen.parse_atom->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.__init__
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.closure
blib2to3.pgen2.pgen.make_dfa->blib2to3.pgen2.pgen.addarc
blib2to3.pgen2.pgen.closure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.addclosure->blib2to3.pgen2.pgen.addclosure
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.simplify_dfa->blib2to3.pgen2.pgen.unifystate
blib2to3.pgen2.pgen.addfirstsets->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.calcfirst->blib2to3.pgen2.pgen.calcfirst
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_first
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.grammar.__init__
blib2to3.pgen2.pgen.make_grammar->blib2to3.pgen2.pgen.__eq__
blib2to3.pgen2.pgen.make_first->blib2to3.pgen2.pgen.make_label
blib2to3.pgen2.pgen.make_label->blib2to3.pgen2.pgen.<module>
blib2to3.pgen2.grammar.dump->posixpath.dirname
blib2to3.pgen2.grammar.dump->tempfile.func_wrapper
blib2to3.pgen2.grammar.dump->tempfile.__getattr__
blib2to3.pgen2.grammar.dump->tempfile.__exit__
blib2to3.pgen2.grammar.dump->tempfile.NamedTemporaryFile
blib2to3.pgen2.grammar.dump->tempfile.__enter__
blib2to3.pgen2.grammar.copy->blib2to3.pgen2.grammar.__init__
black.dont_increase_indentation->typing.inner
black.dont_increase_indentation->functools.wraps
black.dont_increase_indentation->functools.update_wrapper
black.format_str->black.split_line
black.format_str->black.supports_feature
black.format_str->.__init__
black.format_str->black.detect_target_versions
black.format_str->black.visit
black.format_str->black.normalize_fmt_off
black.format_str->black.maybe_empty_lines
black.format_str->enum.__hash__
black.format_str->typing.__new__
black.format_str->black.<setcomp>
black.format_str->black.lib2to3_parse
black.format_str->black.__str__
black.format_str->black.get_future_imports
black.lib2to3_parse->blib2to3.pgen2.tokenize.generate_tokens
black.lib2to3_parse->blib2to3.pgen2.driver.parse_string
black.lib2to3_parse->blib2to3.pgen2.driver.__init__
black.lib2to3_parse->black.get_grammars
blib2to3.pgen2.driver.__init__->logging.getLogger
blib2to3.pgen2.driver.parse_string->blib2to3.pgen2.driver.parse_tokens
blib2to3.pgen2.driver.parse_tokens->logging.debug
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.tokenize.generate_tokens
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.__init__
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.setup
blib2to3.pgen2.driver.parse_tokens->blib2to3.pgen2.parse.addtoken
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.push
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.classify
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.pop
blib2to3.pgen2.parse.addtoken->blib2to3.pgen2.parse.shift
blib2to3.pgen2.parse.shift->blib2to3.pytree.convert
blib2to3.pytree.convert->blib2to3.pytree.__new__
blib2to3.pytree.convert->blib2to3.pytree.__init__
blib2to3.pgen2.parse.pop->blib2to3.pytree.convert
blib2to3.pytree.__init__->blib2to3.pytree.invalidate_sibling_maps
black.get_future_imports->typing.inner
black.detect_target_versions->enum.__iter__
black.detect_target_versions->black.<setcomp>
black.detect_target_versions->black.get_features_used
black.get_features_used->blib2to3.pytree.pre_order
blib2to3.pytree.pre_order->blib2to3.pytree.pre_order
black.normalize_fmt_off->black.convert_one_fmt_off_pair
black.convert_one_fmt_off_pair->blib2to3.pytree.leaves
black.convert_one_fmt_off_pair->black.list_comments
black.convert_one_fmt_off_pair->blib2to3.pytree.prefix
blib2to3.pytree.leaves->blib2to3.pytree.leaves
black.list_comments->.__init__
black.list_comments->black.make_comment
black.supports_feature->black.<genexpr>
black.visit->black.visit_simple_stmt
black.visit->black.visit_default
black.visit->black.visit_stmt
black.visit->black.visit_ENDMARKER
black.visit->blib2to3.pytree.type_repr
blib2to3.pytree.type_repr->importlib._bootstrap.parent
black.visit_default->black.any_open_brackets
black.visit_default->black.visit_default
black.visit_default->black.visit
black.visit_default->black.append
black.visit_default->black.normalize_prefix
black.visit_default->black.generate_comments
black.visit_simple_stmt->black.visit_default
black.visit_simple_stmt->black.line
black.line->.__init__
black.line->black.__bool__
black.visit_stmt->black.normalize_invisible_parens
black.visit_stmt->black.visit
black.normalize_invisible_parens->black.is_one_tuple
black.normalize_invisible_parens->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.prefix
blib2to3.pytree.prefix->blib2to3.pytree.changed
black.generate_comments->black.list_comments
black.generate_comments->blib2to3.pytree.__new__
black.generate_comments->blib2to3.pytree.prefix
black.generate_comments->blib2to3.pytree.__init__
black.normalize_prefix->blib2to3.pytree.prefix
blib2to3.pytree.changed->blib2to3.pytree.changed
black.append->black.append_comment
black.append->black.is_complex_subscript
black.append->black.maybe_remove_trailing_comma
black.append->blib2to3.pytree.prefix
black.append->black.whitespace
black.append->black.mark
black.mark->black.is_split_after_delimiter
black.mark->black.maybe_increment_for_loop_variable
black.mark->black.maybe_decrement_after_lambda_arguments
black.mark->black.is_split_before_delimiter
black.mark->black.maybe_increment_lambda_arguments
black.mark->black.maybe_decrement_after_for_loop_variable
black.is_split_before_delimiter->black.is_vararg
black.is_complex_subscript->black.get_open_lsqb
black.whitespace->blib2to3.pytree.prev_sibling
black.whitespace->black.preceding_leaf
blib2to3.pytree.prev_sibling->blib2to3.pytree.update_sibling_maps
black.preceding_leaf->blib2to3.pytree.prev_sibling
black.append_comment->black.any_open_brackets
black.append_comment->blib2to3.pytree.prefix
black.maybe_empty_lines->black._maybe_empty_lines
black._maybe_empty_lines->black.is_def
black._maybe_empty_lines->black.is_decorator
black._maybe_empty_lines->black.is_import
black._maybe_empty_lines->blib2to3.pytree.prefix
black._maybe_empty_lines->black.is_class
black._maybe_empty_lines->black.__bool__
black.is_decorator->black.__bool__
black.is_class->black.__bool__
black.split_line->black.split_line
black.split_line->black.is_def
black.split_line->black.contains_inner_type_comments
black.split_line->black.is_comment
black.split_line->black.is_line_short_enough
black.split_line->typing.inner
black.split_line->black.split_wrapper
black.split_line->black.rhs
black.split_line->black.__str__
black.__str__->blib2to3.pytree.prefix
black.__str__->blib2to3.pytree.__unicode__
black.__str__->black.__bool__
blib2to3.pytree.__unicode__->blib2to3.pytree.prefix
black.rhs->black.right_hand_split
black.rhs->black.is_line_short_enough
black.rhs->black.generate_trailers_to_omit
black.right_hand_split->black.bracket_split_build_line
black.right_hand_split->black.bracket_split_succeeded_or_raise
black.right_hand_split->black.ensure_visible
black.right_hand_split->black.__bool__
black.bracket_split_build_line->black.should_explode
black.bracket_split_build_line->.__init__
black.bracket_split_build_line->black.comments_after
black.bracket_split_build_line->blib2to3.pytree.__new__
black.bracket_split_build_line->blib2to3.pytree.__init__
black.bracket_split_build_line->black.is_import
black.bracket_split_build_line->black.append
black.bracket_split_build_line->black.normalize_prefix
black.is_import->black.is_import
black.is_import->black.__bool__
black.should_explode->black.max_delimiter_priority
black.max_delimiter_priority->black.<genexpr>
black.bracket_split_succeeded_or_raise->black.__str__
black.bracket_split_succeeded_or_raise->black.__bool__
black.is_line_short_enough->black.__str__
black.is_line_short_enough->black.contains_standalone_comments
black.split_wrapper->black.delimiter_split
black.split_wrapper->black.normalize_prefix
black.delimiter_split->.__init__
black.delimiter_split->black.comments_after
black.delimiter_split->typing.inner
black.delimiter_split->black.is_vararg
black.delimiter_split->black.max_delimiter_priority
black.delimiter_split->black.append_to_line
black.delimiter_split->black.__bool__
black.append_to_line->black.append_safe
black.append_to_line->.__init__
black.append_to_line->black.append
black.append_safe->black.is_comment
black.append_safe->black.append
black.visit_ENDMARKER->black.visit_default
black.visit_ENDMARKER->black.line
black.assert_equivalent->black._v
black.assert_equivalent->typing.inner
black.assert_equivalent->ast.parse
black._v->black._v
black.assert_stable->black.format_str

# Coverage

Name                  Stmts   Miss  Cover   Missing
---------------------------------------------------
black.py               1900   1083    43%   103-106, 125, 177-190, 205-230, 376-458, 470-492, 511-563, 579-612, 624-645, 657-667, 679, 699, 716-724, 735-740, 746, 754-763, 766, 772-773, 810-827, 835-838, 979, 991, 1020-1024, 1033-1035, 1047-1049, 1060-1062, 1073-1075, 1110, 1134, 1167, 1176-1177, 1181-1182, 1196, 1209, 1219-1220, 1234-1235, 1238-1243, 1248-1252, 1263-1306, 1320-1326, 1334-1336, 1346-1354, 1370, 1416, 1419-1423, 1425, 1433, 1440, 1447-1486, 1526-1536, 1540-1541, 1543, 1551-1552, 1559-1566, 1585, 1591-1594, 1600-1605, 1614-1625, 1629-1631, 1635, 1643-1645, 1696, 1704, 1712-1761, 1764, 1768-1769, 1773-1774, 1778-1791, 1795-1798, 1802-1815, 1819-1828, 1832, 1835-1840, 1843-1847, 1851-1859, 1862-1864, 1868-1869, 1873-1890, 1895, 1905, 1918-1925, 1930-1933, 1941-1958, 1986, 1994, 2001, 2004, 2011, 2022-2026, 2033, 2036, 2039, 2051, 2063, 2066, 2134, 2157, 2162, 2197, 2210, 2224, 2231-2232, 2239, 2249-2275, 2312, 2338-2353, 2383-2387, 2423, 2453-2454, 2459-2460, 2463-2464, 2485, 2490, 2494, 2510, 2519-2542, 2562-2564, 2578, 2592-2598, 2609-2665, 2674-2701, 2706-2710, 2723-2725, 2731-2735, 2738-2741, 2749-2752, 2755-2760, 2784-2819, 2831-2839, 2848-2867, 2872, 2883-2894, 2905-2921, 2935-2944, 2949-2950, 2955-2963, 2968-2975, 2988-3007, 3030, 3036-3037, 3053-3055, 3058-3059, 3066-3078, 3104-3138, 3146-3158, 3162, 3166-3173, 3178-3180, 3198-3224, 3237-3254, 3270-3282, 3286-3287, 3290-3291, 3304-3310, 3317-3339, 3355-3356, 3369-3370, 3375, 3384-3386, 3394-3396, 3405-3406, 3418-3422, 3432-3441, 3446-3450, 3457-3459, 3464-3485, 3494, 3502-3504, 3509-3512, 3522-3535, 3559-3585, 3595-3674, 3678, 3686-3696, 3701-3702, 3711-3718, 3723-3731, 3745-3753, 3757-3759, 3763
blackd.py               100     71    29%   42-46, 50-64, 68-121, 125-152, 156-158, 162
tests/__init__.py         0      0   100%
tests/test_black.py    1187    956    19%   36-37, 54, 76, 82-87, 92-102, 109, 120-124, 128-136, 145-158, 164-168, 172-176, 179-187, 191-196, 200-205, 208-217, 220-240, 244-249, 253-257, 261-265, 269-273, 276-287, 290-312, 316-320, 324-333, 337-341, 345-349, 353-357, 361-365, 369-373, 377-381, 385-389, 401-405, 409-413, 417-421, 425-429, 433-437, 441-446, 450-455, 459-462, 466-470, 474-478, 482-485, 489-493, 497-503, 507-511, 515-519, 523-527, 531-535, 539-543, 546-565, 568-656, 663-743, 750-833, 840-862, 865-893, 896-923, 926-943, 950-967, 970-973, 977-993, 996-1007, 1010-1018, 1022-1040, 1043-1050, 1053-1060, 1063-1065, 1068-1075, 1078-1091, 1094-1098, 1102-1115, 1118-1121, 1125-1133, 1136-1138, 1141-1147, 1150-1159, 1162-1177, 1181-1202, 1205-1211, 1214-1229, 1233-1254, 1257-1265, 1268-1281, 1284-1305, 1308-1326, 1329-1330, 1333-1342, 1345-1355, 1358-1359, 1362-1390, 1393-1412, 1415-1427, 1432-1437, 1442-1446, 1451-1456, 1464-1469, 1474-1479, 1484-1503, 1508-1515, 1520-1547, 1552-1561, 1566-1571, 1576-1583, 1587-1591, 1595
---------------------------------------------------
TOTAL                  3187   2110    34%

